<% position = Time.now.to_i.to_s + Time.now.usec.to_s %>
<div id="variable_<%= position %>" class="<%= 'fieldset_with_errors' if @design.errors.keys.include?(:variables) %> well" data-object="expand-details" data-target=".variable_<%= position %>_details" data-target-hide=".variable_<%= position %>_compact" data-selector="variabledetails" data-inverse-selector="variablecompact">
  <% if false %>
  <div class="page-header" style="margin-top:0px">
    <h3>Variable <%= link_to 'Remove', "#", data: { object: 'remove', target: "variable_#{position}" }, class: 'btn btn-mini btn-danger' %></h3>
  </div>
  <% end %>

  <div class="row">
    <%= link_to 'Remove', "#", data: { object: 'remove', target: "variable_#{position}" }, class: 'btn btn-mini btn-danger', style: 'float:right' %>
    <% @variable = @all_viewable_variables.find_by_id(@option[:variable_id]) %>
    <%= link_to 'Edit', '#', class: 'btn btn-mini', style: 'float:right;margin-right:5px', data: { object: 'popup-variable', position: position } %>

    <div class="span4">
      <div class="control-group" style="margin-bottom:0px">
        <%= label_tag "design_option_tokens_#{position}_variable_id", 'Variable', class: 'control-label' %>
        <div class="controls">
          <%= select_tag "design[option_tokens][#{position}][variable_id]", options_for_select([[nil, nil]] + @select_variables, @option[:variable_id]), style: 'width:99%', data: { object: 'variable-load', position: position, placeholder: 'Choose a Variable' }, class: 'chzn-select' %>
        </div>
      </div>
      <div class="variable_<%= position %>_details" style="display:none" data-object="variabledetails">
        <div class="control-group" style="margin-top:18px">
          <%= label_tag "design_option_tokens_#{position}_condition", 'Show If', class: 'control-label' %>
          <div class="controls">
            <%= select_tag "design[option_tokens][#{position}][condition_variable_id]", options_for_select([['---', nil]] + @design.variables.select{|v| v.id != @option[:variable_id].to_i}.collect{|v| [v.name, v.id]}, @option[:condition_variable_id]), style: 'width:99%', data: { object: 'variable-load', position: position } %>
          </div>
        </div>
        <div class="control-group">
          <%= label_tag "design_option_tokens_#{position}_condition_value", 'Values', class: 'control-label' %>
          <div class="controls">
            <%= text_field_tag "design[option_tokens][#{position}][condition_value]", @option[:condition_value] %>
          </div>
        </div>
        <div class="control-group">
          <%= label_tag "design_option_tokens_#{position}_branching_logic", 'Branching Logic', class: 'control-label' %>
          <div class="controls">
            <%= text_area_tag "design[option_tokens][#{position}][branching_logic]", @option[:branching_logic], rows: 3, style: 'width:90%',
                rel: "popover", data: { content: "
                  <table class='table table-bordered'>
                  <tbody>
                    <tr><td style='font-weight:bold'>General</td><td>variable == 5</td></tr>
                    <tr><td style='font-weight:bold'>OR</td><td>a > 5 || b < 2</td></tr>
                    <tr><td style='font-weight:bold'>AND</td><td>a > 5 && a < 10</td></tr>
                    <tr><td style='font-weight:bold'>Checkbox</td><td>intersection(variable, ['5']).length > 0</td></tr>
                  </tbody>
                  </table>
                  ", title: "Branching Logic Examples", placement: 'bottom' } %>
          </div>
        </div>
        <div class="control-group" style="margin-bottom:0px;">
          <div class="controls">
            <%= link_to 'Add Variable After', '#', class: 'btn btn-mini', data: { object: 'variable-insert-after', position: position } %>
            <%= link_to 'Add Section After', '#', class: 'btn btn-mini', data: { object: 'section-insert-after', position: position } %>
          </div>
        </div>
      </div>
    </div>

    <div class="span4">
      <% @variable = @all_viewable_variables.find_by_id(@option[:variable_id]) %>
      <div class="variable_<%= position %>_compact" id="design_<%= position %>_variable_preview_name" data-object="variablecompact"><%= @variable.display_name if @variable %></div>
      <div class="variable_<%= position %>_details" id="design_<%= position %>_variable_preview" style="margin-bottom:-18px;display:none" data-object="variabledetails">
        <%= render partial: 'designs/variable', locals: { disabled: 'disabled' } if @variable %>
      </div>
    </div>
  </div>
</div>

<%= javascript_tag do %>
$('#design_option_tokens_<%= position %>_variable_id.chzn-select').chosen();
$('#variable_<%= position %>').click();
<% end %>
