\documentclass{article}
\usepackage{graphicx}
\usepackage{fancyhdr}
\usepackage[margin=0.5in<%= ',landscape' if orientation == 'landscape' %>]{geometry}
\geometry{top=1.0in, bottom=1.0in}
\usepackage{lastpage}
\usepackage{wrapfig}
\usepackage[section]{placeins}
\usepackage{booktabs}
\usepackage{sectsty}
\newcommand{\ra}[1]{\renewcommand{\arraystretch}{#1}}
\usepackage{indentfirst}
\usepackage{longtable}


\usepackage{hyperref}
\usepackage{pifont}

\usepackage{needspace}
\usepackage{color}
\usepackage{sparklines}

\fancyhf{}

\lhead{<%= latex_safe @design.project.name %>}
\chead{\textbf{<%= latex_safe @report_title %>}}
\rhead{<%= latex_safe @design.name %>}
\lfoot{}
\cfoot{<%= latex_safe Date.today.strftime("%B %-d, %Y") %>}
\rfoot{\thepage\ of \pageref{LastPage}}


  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
  \setlength\headheight{22pt}

\pagestyle{fancyplain}

\definecolor{sparkrectanglecolor}{gray}{0.95}


\begin{document}

<% if false %>
<%= latex_safe @design.name %> \cdot <%= latex_safe @design.project.name %>
<% end %>

\begin{longtable}{ll@{\extracolsep{\fill}}<%= 'l'*ranges.count %>l}
  <%# Header %>
  &
  \textbf{<%= latex_safe(@variable ? @variable.display_name : 'Site') %>} &
  <% @ranges.each do |hash| %>
    <%= hash[:name].blank? ? "\\textcolor[gray]{0.5}{Unknown}" : latex_safe(hash[:name].truncate(10)) %>
    &
  <% end %>
  Total \\
  \midrule


  <%# Body %>
  <% @strata.each do |stratum| %>
    <% row_counts = @ranges.collect{|hash| hash[:scope].with_stratum(@variable, stratum[:value]).count } %>
    <% if row_counts.sum > 0 %>
    <% graph_row_counts = (row_counts.size == 1 ? row_counts * 2 : row_counts) %>
    \begin{sparkline}{4}
    \sparkrectangle 0.0 1.0
    \spark <% graph_row_counts.each_with_index do |row_count, index| %><%= " %0.2f " % (index / ([graph_row_counts.size - 1, 1].max).to_f) %> <%= graph_row_counts.max > 0 ? "%0.2f" % (row_count / graph_row_counts.max.to_f) : '0.00' %><% end %> /
    \end{sparkline}
    <% end %>
    &

    <% link_name = ((@variable.blank? or stratum[:value].blank? or stratum[:value] == stratum[:name]) ? '' :  "#{stratum[:value]}: ") + stratum[:name] %>
    <% if stratum[:name].blank? %>
      \textcolor[gray]{0.5}{Unknown}
    <% else %>
      <%= latex_safe link_name %>
    <% end %>
    <% unless stratum[:info].blank? %>\textcolor[gray]{0.5}{<%= latex_safe stratum[:info] %>}<% end %>
    &

    <% @ranges.each do |hash| %>
      <% count = hash[:scope].with_stratum(@variable, stratum[:value]).count %>
      <%= count == 0 ? "\\textcolor[gray]{0.5}{-}" : count %>
      <% if @percent == 'row' and count > 0 and row_counts.sum > 0 %>
        \small{\textcolor[gray]{0.5}{<%= latex_safe((count * 100 / row_counts.sum).to_s + "%") %>}}
      <% end %>
      <% if @percent == 'column' and count > 0 and hash[:count] > 0 %>
        \small{\textcolor[gray]{0.5}{<%= latex_safe((count * 100 / hash[:count]).to_s + "%") %>}}
      <% end %>
      &
    <% end %>

    <% count = @sheets.with_stratum(@variable, stratum[:value]).count %>
    <%= count == 0 ? "\\textcolor[gray]{0.5}{-}" : count %>
    <% if @percent == 'column' and count > 0 and @sheets.count > 0 %>
      \small{\textcolor[gray]{0.5}{<%= latex_safe((count * 100 / @sheets.count).to_s + "%") %>}}
    <% end %>
    \\
    \midrule
  <% end %>

  <%# Footer %>
  <% row_counts = @ranges.collect{|hash| hash[:count] } %>
  <% if row_counts.sum > 0 %>
    <% graph_row_counts = (row_counts.size == 1 ? row_counts * 2 : row_counts) %>
    \begin{sparkline}{4}
    \sparkrectangle 0.0 1.0
    \spark <% graph_row_counts.each_with_index do |row_count, index| %><%= " %0.2f " % (index / ([graph_row_counts.size - 1, 1].max).to_f) %> <%= graph_row_counts.max > 0 ? "%0.2f" % (row_count / graph_row_counts.max.to_f) : '0.00' %><% end %> /
    \end{sparkline}
  <% end %>
  &
  \textbf{Total} &
  <% @ranges.each do |hash| %>
    <% count = hash[:count] %>
    <%= count == 0 ? "\\textcolor[gray]{0.5}{-}" : count %>
    <% if @percent == 'row' and count > 0 and row_counts.sum > 0 %>
      \small{\textcolor[gray]{0.5}{<%= latex_safe((count * 100 / row_counts.sum).to_s + "%") %>}
    <% end %>
    &
  <% end %>
  <% count = @sheets.count %>
  <%= count == 0 ? "\\textcolor[gray]{0.5}{-}" : count %>} \\

\end{longtable}

\centerline{<%= latex_safe @report_caption %>}


\end{document}
