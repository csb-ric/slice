- @last_seen_at = @adverse_event.last_seen_at current_user
- all_events = (@adverse_event.sheets + @adverse_event.adverse_event_files + adverse_event_comments + @adverse_event.adverse_event_users).sort_by(&:created_at)
- @adverse_event.mark_as_viewed_by_user current_user

.comment-outer
  .comment-left-fixed
  .comment-right-fluid
    .jumbotron
      %strong= @adverse_event.user.name
      %span.label.label-success reported
      a
      - if @adverse_event.serious?
        %strong serious
      - else
        non-serious
      adverse event that occurred on
      = @adverse_event.adverse_event_date.strftime('%a, %-d %b %Y')
      for subject
      = succeed '.' do
        = link_to @adverse_event.subject.name, [@project, @adverse_event.subject]

%a.anchor-top{ name: 'comment-1' }
.comment-outer
  .comment-left-fixed
    = image_tag @adverse_event.user.avatar_url(48, 'identicon'), size: '48x48', alt: ''
  .comment-right-fluid
    .comment-comment
      .comment-comment-header{ class: (@last_seen_at == nil || @last_seen_at < @adverse_event.created_at ? 'comment-unread' : nil) }
        .pull-right
          - if @adverse_event.editable_by? current_user
            = succeed ' ' do
              = link_to edit_project_adverse_event_path(@project, @adverse_event), class: 'btn btn-xs btn-default' do
                %span.glyphicon.glyphicon-pencil
          = link_to '#1', '#comment-1', class: 'btn btn-link btn-xs'
        %strong= @adverse_event.user.name
        commented
        %abbr{ rel: 'tooltip', data: { title: @adverse_event.created_at.strftime("%-d %b %Y, %-l:%M %p"), container: 'body', placement: 'right' } }
          = time_ago_in_words @adverse_event.created_at
          ago
      .comment-comment-body
        = simple_markdown @adverse_event.description, 'table table-bordered table-striped'

- @adverse_event.compress_events(all_events).each do |event|
  - if event.is_a? Array
    %div
      .comment-outer
        .comment-left-fixed
        .comment-right-fluid
          .comment-action
            .pull-right
              %small Seen by
              - event.each do |adverse_event_user|
                = image_tag adverse_event_user.user.avatar_url(16, 'identicon'), size: '16x16', alt: '', rel: 'tooltip', data: { title: adverse_event_user.user.name, container: 'body', placement: 'top' }
            &nbsp;
  - elsif event.is_a? AdverseEventComment
    %div{ id: "adverse_event_comment_#{event.id}" }
      = render 'adverse_event_comments/show', adverse_event_comment: event
  - elsif event.is_a? Sheet
    - sheet = event
    %div
      .comment-outer
        .comment-left-fixed
        .comment-right-fluid
          .comment-icon
            %span.glyphicon.glyphicon-file
          .comment-action{ class: (@last_seen_at == nil || @last_seen_at < sheet.updated_at ? 'comment-unread' : nil) }
            %strong= sheet.user.name if sheet.user
            added
            = link_to sheet.name, [@project, sheet]
            %abbr{ rel: 'tooltip', data: { title: sheet.created_at.strftime("%-d %b %Y, %-l:%M %p"), container: 'body', placement: 'right' } }
              = time_ago_in_words sheet.created_at
              ago
            - if sheet.created_at != sheet.updated_at
              and updated
              %abbr{ rel: 'tooltip', data: { title: sheet.updated_at.strftime("%-d %b %Y, %-l:%M %p"), container: 'body', placement: 'right' } }
                = time_ago_in_words sheet.updated_at
                ago
  - elsif event.is_a? AdverseEventFile
    - file = event
    %div
      .comment-outer
        .comment-left-fixed
        .comment-right-fluid
          .comment-icon
            - if file.image?
              %span.glyphicon.glyphicon-picture
            - else
              %span.glyphicon.glyphicon-paperclip
          .comment-action{ class: (@last_seen_at == nil || @last_seen_at < file.created_at ? 'comment-unread' : nil) }
            %strong= file.user.name if file.user
            attached
            = succeed '.' do
              - if file.image?
                = link_to file.name, [@project, @adverse_event, file]
              - else
                = link_to file.name, download_project_adverse_event_adverse_event_file_path(@project, @adverse_event, file), data: { no_turbolink: true }
            - if file.image? and false
              .center{ style: 'margin-top:5px' }
                = link_to [@project, @adverse_event, file] do
                  = image_tag download_project_adverse_event_adverse_event_file_path(@project, @adverse_event, file), style: 'height: 64px', class: 'img-thumbnail'

- if @adverse_event.editable_by? current_user
  #adverse_event_comment_new
    - @adverse_event_comment = current_user.adverse_event_comments.where(project_id: @project.id, adverse_event_id: @adverse_event.id).new
    = render 'adverse_event_comments/form'
