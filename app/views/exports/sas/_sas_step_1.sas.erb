<% variables = (use_grids ? @export_formatter.grid_variables : @export_formatter.variables) %>

<% column_headers = variables.collect(&:csv_column).flatten %>
<% column_informats = variables.collect(&:sas_informat_definition).flatten %>
<% column_formats = variables.collect(&:sas_format_definition).flatten %>

/* Replace carriage returns inside delimiters */
data _null_;
  infile "&path_file<%= '_grids' if use_grids %>..csv" recfm=n;
  file "&path_file<%= '_grids' if use_grids %>._sas.csv" recfm=n;
  input a $char1.;
  retain open 0;
  if a='"' then open=not open;
  if (a='0A'x or a='0D'x) and open then put '00'x @;
  else put a $char1. @;
run;

/* Step 1: Import data into slice work library */

data slice<%= '_grids' if use_grids %>;
  infile "&path_file<%= '_grids' if use_grids %>._sas.csv" delimiter = ',' MISSOVER DSD lrecl=32767 firstobs=<%= use_grids ? 3 : 2 %> ;

  /* Design and Subject Variables */
  informat _sheet_id             best32.   ;   * Sheet ID ;
  informat _name                 $500.     ;   * Design name ;
  informat _description          $5000.    ;   * Design description ;
  informat _sheet_creation_date  yymmdd10. ;   * Sheet creation date ;
  informat _project              $500.     ;   * Project name ;
  informat _site                 $500.     ;   * Subject site name ;
  informat _subject              $100.     ;   * Subject code ;
  informat _acrostic             $100.     ;   * Subject acrostic ;
  informat _status               $10.      ;   * Subject status ;
  informat _creator              $100.     ;   * Sheet creator ;
  informat _schedule_name        $500.     ;   * Schedule name ;
  informat _event_name           $500.     ;   * Event name ;

  /* Sheet Variables */
<%= column_informats.join("\n") %>

  /* Design and Subject Variables */
  format _sheet_id               best32.   ;
  format _name                   $500.     ;
  format _description            $500.     ;
  format _sheet_creation_date    yymmdd10. ;
  format _project                $500.     ;
  format _site                   $500.     ;
  format _subject                $100.     ;
  format _acrostic               $100.     ;
  format _status                 $10.      ;
  format _creator                $100.     ;
  format _schedule_name          $500.     ;
  format _event_name             $500.     ;

  /* Sheet Variables */
<%= column_formats.join("\n") %>

  /* Define Column Names */

  input
    _sheet_id
    _name
    _description
    _sheet_creation_date
    _project
    _site
    _subject
    _acrostic
    _status
    _creator
    _schedule_name
    _event_name
<%= column_headers.collect{ |c| "    #{c}" }.join("\n") %>
  ;
run;
