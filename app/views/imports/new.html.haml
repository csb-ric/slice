- @title = 'Design Import'
- @menu_title = "#{@project.name} #{@title}"

= render 'projects/side_nav'

- content_for :header do
  .background-gradient
  .header-container
    .container
      %h1.page-heading
        = render 'layouts/side_nav_header_button'
        = @title

- @file_uploaded = (@variables.size > 0 && @design.csv_file_cache.present? && @design.errors[:csv_file].blank?)

.dashboard-container
  = form_for @design, url: imports_project_designs_path(@project), method: :post, html: { class: 'form-horizontal', multipart: true } do |f|
    - if @design.errors.any?
      .callout.callout-danger
        %strong
          = pluralize @design.errors.count, 'error'
          prohibited this design from being saved

        %ul
          - @design.errors.full_messages.each do |msg|
            %li= msg

    .form-group
      = f.label :csv_file, 'Data Import (CSV)', class: 'col-md-2 control-label'
      .col-md-10
        - if @file_uploaded
          %div{ style: "padding-top:5px;" }
            %strong= @design.csv_file_cache.split('/').last
            = f.hidden_field :csv_file_cache
        - else
          = f.file_field :csv_file, class: 'form-control'

    - if @file_uploaded
      .form-group
        = f.label :name, nil, class: 'col-md-2 control-label'
        .col-md-10
          = f.text_field :name, class: 'form-control'

      .form-group
        = label_tag 'site_id', 'Site', class: 'col-md-2 control-label'
        #site.col-md-10
          = select_tag :site_id, options_for_select(@project.sites.order('name').collect{|s| [s.name, s.id]}), class: 'form-control'

      %hr.divider-sm

      - @variables.each do |hash|
        - variable = @project.variables.find_by_name(hash[:name])

        - if params[:variables] && params[:variables][hash[:name]]
          - display_name = params[:variables][hash[:name]][:display_name]
          - variable_type = params[:variables][hash[:name]][:variable_type]
          - ignore = params[:variables][hash[:name]][:ignore]
        - else
          - display_name = hash[:display_name]
          - variable_type = hash[:variable_type]
          - ignore = (variable && !Variable::TYPE_IMPORTABLE.flatten.include?(variable.variable_type))

        .form-group
          %label.col-md-2.control-label= hash[:name]
          .col-md-10.sheet-container{ style: 'padding-top:5px' }
            .row
              - if variable
                .col-xs-6
                  = link_to variable.display_name, [variable.project, variable], target: '_blank'
                  of type
                  %strong= variable.variable_type
                  won't be recreated.
                  = hidden_field_tag "variables[#{hash[:name]}][display_name]", display_name
              - else
                .col-xs-3
                  = text_field_tag "variables[#{hash[:name]}][display_name]", display_name, class: 'form-control'
                .col-xs-3
                  = select_tag "variables[#{hash[:name]}][variable_type]", options_for_select(Variable::TYPE_IMPORTABLE, variable_type), class: 'form-control'
              .col-xs-6
                %label.checkbox.checkbox-inline.nowrap{ class: "#{'selected' if ignore}" }
                  = check_box_tag "variables[#{hash[:name]}][ignore]", '1', ignore
                  do not add to design

    .form-group
      .col-md-10.col-md-offset-2
        = f.submit @variables.size > 0 ? 'Import Data' : 'Proceed to Import Specification', class: 'btn btn-primary'
        - if @file_uploaded
          = link_to 'Previous Step', imports_new_project_designs_path(@project), class: 'btn btn-default'
        - else
          = link_to 'Cancel', project_designs_path(@project), class: 'btn btn-default'
