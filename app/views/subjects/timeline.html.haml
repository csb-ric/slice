- @title = 'Timeline'

= render 'subjects/header'

.row
  .col-sm-2
    = render 'subjects/event_navigation'

  .col-sm-10
    %h2
      Timeline

    - events = (@subject.blinded_sheets(current_user).original_entry.order(created_at: :desc) + @subject.blinded_comments(current_user).to_a + @subject.subject_events.to_a + @subject.randomizations.to_a).sort_by(&:event_at).reverse

    - events.each_with_index do |event, index|
      - current_index = events.count - index + 1
      - current_page = (params[:page].to_i > 1 ? params[:page].to_i : 1)
      - if event.class == Sheet
        - sheet = event
        %a.anchor-top{ name: "c#{current_index}" }
        .comment-outer
          .comment-left-fixed
          .comment-right-fluid
            .comment-icon
            .comment-action
              %strong
                - if sheet.user
                  = sheet.user.name
                - else
                  Public user
              added
              = link_to sheet.name, [@project, sheet]
              %abbr{ rel: 'tooltip', data: { title: sheet.created_at.strftime('%-d %B %Y, %-l:%M %p'), container: 'body', placement: 'right' } }
                = time_ago_in_words(sheet.created_at)
                ago
      - elsif event.class == SubjectEvent
        - subject_event = event
        %a.anchor-top{ name: "c#{current_index}" }
        .comment-outer
          .comment-left-fixed
          .comment-right-fluid
            .comment-icon
              %span.glyphicon.glyphicon-calendar
            .comment-action
              %strong
                - if subject_event.user
                  = subject_event.user.name
                - else
                  Public user
              added
              = link_to subject_event.event.name, event_project_subject_path(@project, @subject, event_id: subject_event.event, subject_event_id: subject_event.id, event_date: subject_event.event_date_to_param)
              %abbr{ rel: 'tooltip', data: { title: subject_event.created_at.strftime('%-d %B %Y, %-l:%M %p'), container: 'body', placement: 'right' } }
                = time_ago_in_words(subject_event.created_at)
                ago
      - elsif event.class == Randomization
        - randomization = event
        %a.anchor-top{ name: "c#{current_index}" }
        .comment-outer
          .comment-left-fixed
          .comment-right-fluid
            .comment-icon
              %span.glyphicon.glyphicon-random
            .comment-action
              %strong
                - if randomization.randomized_by
                  = randomization.randomized_by.name
                - else
                  Public user
              randomized subject to
              = link_to randomization.treatment_arm.name, [@project, randomization]
              %abbr{ rel: 'tooltip', data: { title: randomization.randomized_at.strftime('%-d %B %Y, %-l:%M %p'), container: 'body', placement: 'right' } }
                = time_ago_in_words(randomization.randomized_at)
                ago
      - elsif event.class == Comment
        - comment = event
        %a.anchor-top{ name: "c#{current_index}" }
        - unless comment.deleted?
          .comment-outer
            .comment-left-fixed
              = image_tag comment.user.avatar_url(48, 'identicon'), size: '48x48', alt: ''
            .comment-right-fluid
              .comment-comment
                .comment-comment-header
                  %strong= comment.user.name
                  commented
                  on
                  = link_to comment.sheet.name, [@project, comment.sheet]
                  %abbr{ rel: 'tooltip', data: { title: comment.created_at.strftime('%-d %b %Y, %-l:%M %p'), container: 'body', placement: 'right' } }
                    = time_ago_in_words comment.created_at
                    ago
                  .pull-right
                    - if comment.editable_by? current_user
                      = succeed ' ' do
                        = link_to edit_comment_path(comment), class: 'btn btn-xs btn-default' do
                          %span.glyphicon.glyphicon-pencil
                    = link_to "##{current_index}", "#c#{current_index}", class: 'btn btn-link btn-xs'
                .comment-comment-body
                  = render 'comments/formatted', comment: comment
    .comment-outer
      .comment-left-fixed
      .comment-right-fluid
        .jumbotron
          %strong
            - if @subject.user
              = @subject.user.name
            - else
              Public user
          %span.label.label-success created
          subject
          = link_to @subject.name, [@project, @subject]
          on
          = @subject.created_at.strftime('%a, %B %-d, %Y at %-l:%M %p.')
