<?xml version="1.0"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
  xmlns:o="urn:schemas-microsoft-com:office:office"
  xmlns:x="urn:schemas-microsoft-com:office:excel"
  xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
  xmlns:html="http://www.w3.org/TR/REC-html40">
  <% [false, true].each do |raw_data| %>
    <Worksheet ss:Name="Sheets - <%= raw_data ? 'RAW' : 'Labeled' %>">
      <Table>
        <% variable_names = @sheet_scope.collect(&:variables).flatten.uniq.collect{|v| [v.name, 'String']}.uniq %>
        <Row>
          <% (["Name", "Description", "Sheet Date", "Project", "Site", "Subject", "Acrostic", "Creator"] + variable_names.collect{|v| v[0]}).each do |name| %>
            <Cell><Data ss:Type="String"><%= name %></Data></Cell>
          <% end %>
        </Row>
      <% @sheet_scope.each do |sheet| %>
        <Row>
          <Cell><Data ss:Type="String"><%= sheet.name %></Data></Cell>
          <Cell><Data ss:Type="String"><%= sheet.description %></Data></Cell>
          <Cell><Data ss:Type="String"><%= sheet.study_date.blank? ? '' : sheet.study_date.strftime("%m-%d-%Y") %></Data></Cell>
          <Cell><Data ss:Type="String"><%= sheet.project.name %></Data></Cell>
          <Cell><Data ss:Type="String"><%= sheet.subject.site.name %></Data></Cell>
          <Cell><Data ss:Type="String"><%= sheet.subject.name %></Data></Cell>
          <Cell><Data ss:Type="String"><%= sheet.project.acrostic_enabled? ? sheet.subject.acrostic : nil %></Data></Cell>
          <Cell><Data ss:Type="String"><%= sheet.user.name %></Data></Cell>

          <% variable_names.each do |name, type| %>
            <% value = if variable = sheet.variables.find_by_name(name) %>
              <% raw_data ? variable.response_raw(sheet) : (variable.variable_type == 'checkbox' ? variable.response_name(sheet).join(',') : variable.response_name(sheet)) %>
            <% else %>
              <% '' %>
            <% end %>
            <Cell><Data ss:Type="<%= type %>"><%= value %></Data></Cell>
          <% end %>
        </Row>
      <% end %>
      </Table>
    </Worksheet>

    <Worksheet ss:Name="Grids - <%= raw_data ? 'RAW' : 'Labeled' %>">
      <Table>
        <% variable_ids = SheetVariable.where(sheet_id: @sheet_scope.pluck(:id)).collect(&:variable_id) %>
        <% grid_group_variables = Variable.current.where(variable_type: 'grid', id: variable_ids) %>
        <% @grids = @sheet_scope.collect(&:sheet_variables).flatten.collect(&:grids).flatten.compact.uniq %>

        <Row>
          <% ["Name", "Description", "Sheet Date", "Project", "Site", "Subject", "Acrostic", "Creator"].each do |name| %>
            <Cell><Data ss:Type="String"></Data></Cell>
          <% end %>
          <% grid_group_variables.each do |variable| %>
            <% variable.grid_variables.each do |grid_variable_hash| %>
              <% grid_variable = Variable.current.find_by_id(grid_variable_hash[:variable_id]) %>
              <% if grid_variable %>
                <Cell><Data ss:Type="String"><%= variable.name %></Data></Cell>
              <% end %>
            <% end %>
          <% end %>
        </Row>

        <Row>
          <% ["Name", "Description", "Sheet Date", "Project", "Site", "Subject", "Acrostic", "Creator"].each do |name| %>
            <Cell><Data ss:Type="String"><%= name %></Data></Cell>
          <% end %>
          <% grid_group_variables.each do |variable| %>
            <% variable.grid_variables.each do |grid_variable_hash| %>
              <% grid_variable = Variable.current.find_by_id(grid_variable_hash[:variable_id]) %>
              <% if grid_variable %>
                <Cell><Data ss:Type="String"><%= grid_variable.name %></Data></Cell>
              <% end %>
            <% end %>
          <% end %>
        </Row>

    <% @sheet_scope.each do |sheet| %>
      <% (0..sheet.max_grids_position).each do |position| %>
        <Row>
          <Cell><Data ss:Type="String"><%= sheet.name %></Data></Cell>
          <Cell><Data ss:Type="String"><%= sheet.description %></Data></Cell>
          <Cell><Data ss:Type="String"><%= sheet.study_date.blank? ? '' : sheet.study_date.strftime("%m-%d-%Y") %></Data></Cell>
          <Cell><Data ss:Type="String"><%= sheet.project.name %></Data></Cell>
          <Cell><Data ss:Type="String"><%= sheet.subject.site.name %></Data></Cell>
          <Cell><Data ss:Type="String"><%= sheet.subject.name %></Data></Cell>
          <Cell><Data ss:Type="String"><%= sheet.project.acrostic_enabled? ? sheet.subject.acrostic : nil %></Data></Cell>
          <Cell><Data ss:Type="String"><%= sheet.user.name %></Data></Cell>

          <% grid_group_variables.each do |variable| %>
            <% variable.grid_variables.each do |grid_variable_hash| %>
              <% sheet_variable = sheet.sheet_variables.find_by_variable_id(variable.id) %>
              <% result_hash = (sheet_variable ? sheet_variable.response_hash(position, grid_variable_hash[:variable_id]) : {}) %>
              <% if raw_data %>
                <Cell><Data ss:Type="String"><%= result_hash.kind_of?(Array) ? result_hash.collect{|h| h[:value]}.join(',') : result_hash[:value] %></Data></Cell>
              <% else %>
                <Cell><Data ss:Type="String"><%= result_hash.kind_of?(Array) ? result_hash.collect{|h| "#{h[:value]}: #{h[:name]}"}.join(', ') : result_hash[:name] %></Data></Cell>
              <% end %>
            <% end %>
          <% end %>
        </Row>
      <% end %>
    <% end %>
      </Table>
    </Worksheet>
  <% end %>

</Workbook>
