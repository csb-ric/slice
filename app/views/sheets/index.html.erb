<% @title = 'Sheets' %>
<div class="page-header">
  <h1>
    <%= link_to @project.name, @project %> &middot; <%= @title %>
    <%= link_to "Create Sheet", new_project_sheet_path(@project), class: 'btn btn-mini btn-primary' if current_user.all_viewable_projects.pluck(:id).include?(@project.id) %>
    <%= link_to "Batch", batch_project_designs_path(@project), class: 'btn btn-mini' if current_user.all_viewable_projects.pluck(:id).include?(@project.id) %>
  </h1>
</div>

<div id="contour-backdrop" style="display:none"></div>

<%= form_tag project_sheets_path(@project), method: :get, remote: true, id: "sheets_search", class: 'form-search', data: { object: 'form-load' } do %>
  <div class="contour-modal-wrapper" data-object="contour_modal_wrapper" style="display:none">
    <div class="contour-modal" data-object="contour_modal_container">
      <%= render partial: 'sheets/export_popup' %>
    </div>
  </div>

  <%= hidden_field_tag :order %>

  <div class="row">
    <div class="span4 control-group">
      <%= label :search, 'Search', class: 'control-label' %>
      <div class="controls">
        <%= text_field_tag 'search', params[:search], class: 'search-query', data: { object: 'filter' }, placeholder: 'Design Name or Subject Code' %>
      </div>
    </div>
    <div class="span4 control-group">
      <%= label :sheet_after, 'Date after', class: 'control-label' %>
      <div class="controls">
        <%= text_field_tag :sheet_after, params[:sheet_after], class: 'datepicker', data: { object: 'filter' } %>
      </div>
    </div>

    <div class="span4 control-group">
      <%= label :sheet_before, 'Date before', class: 'control-label' %>
      <div class="controls">
        <%= text_field_tag :sheet_before, params[:sheet_before], class: 'datepicker', data: { object: 'filter' } %>
      </div>
    </div>
  </div>

  <div class="row">
    <% if false %>
    <div class="span4 control-group">
      <%= label :project_id, 'Project', class: 'control-label' %>
      <div class="controls">
        <%= select_tag :project_id, options_for_select([['---', nil]] + current_user.all_viewable_projects.order('name').collect{|p| [p.name, p.id]}, params[:project_id] ), data: { object: 'filter' } %>
      </div>
    </div>
    <% end %>
    <div class="span4 control-group">
      <%= label :site_id, 'Site', class: 'control-label' %>
      <div class="controls">
        <%= select_tag :site_id, options_for_select([['---', nil]] + current_user.all_viewable_sites.where(project_id: @project.id).order(:name).collect{|s| [s.name, s.id]}, params[:site_id]), data: { object: 'filter' } %>
      </div>
    </div>
    <div class="span4 control-group">
      <%= label :design_id, 'Design', class: 'control-label' %>
      <div class="controls">
        <%= select_tag :design_id, options_for_select([['---', nil]] + current_user.all_viewable_designs.where(project_id: @project.id).order(:name).collect{|d| [d.name, d.id]}, params[:design_id]), data: { object: 'filter' } %>
      </div>
    </div>
    <div class="span4 control-group">
      <%= label :user_id, 'Creator', class: 'control-label' %>
      <div class="controls">
        <%= select_tag 'user_id', options_for_select([['---', nil]] + User.current.with_sheet.order('last_name, first_name').collect{|u| [u.reverse_name, u.id]}, params[:user_id]), data: { object: 'filter' } %>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="span4 control-group">
      <%= label :statuses, 'Status', class: 'control-label' %>
      <div class="controls">
        <div class="btn-group" data-toggle="buttons-checkbox">
          <% Subject::STATUS.each do |label, value| %>
            <button data-object="set-statuses" data-value="<%= value %>" data-target="#sheets_search" type="button" class="btn btn-mini <%= 'active' if @statuses.include?(value) %>">
              <%= label.humanize %>
              <%= hidden_field_tag "statuses[]", @statuses.include?(value) ? value : '', id: "statuses_#{value}" %>
            </button>
          <% end %>
        </div>
      </div>
    </div>
    <div class="span4 control-group">
      <%= hidden_field_tag :filter, @filter, data: { object: 'filter' } %>
      <%= hidden_field_tag :stratum_id, params[:stratum_id], data: { object: 'filter' } %>
      <%= hidden_field_tag :stratum_value, params[:stratum_value], data: { object: 'filter' } %>
      <%= hidden_field_tag :row_include, params[:row_include] %>
      <% @variable = current_user.all_viewable_variables.find_by_id(params[:stratum_id]) %>
      <% if @variable %>
        <div data-object="filter-html">
          <%= label :stratum_id, 'Stratum', class: 'control-label' %>
          <div class="controls">
            <%= @variable.display_name %>:
            <% option = @variable.options.select{|opt| opt[:value] == params[:stratum_value]}.first %>
            <% if option %>
              <%= option[:name] %>
            <% else %>
              <span class="muted">Unknown</span>
            <% end %>
            <br /><strong>Include <%= params[:row_include] %></strong>
          </div>
        </div>
      <% end %>
    </div>
    <div class="span4 control-group">
      <%= hidden_field_tag :column_stratum_id, params[:column_stratum_id], data: { object: 'filter' } %>
      <%= hidden_field_tag :column_stratum_value, params[:column_stratum_value], data: { object: 'filter' } %>
      <%= hidden_field_tag :column_include, params[:column_include] %>
      <% @variable = current_user.all_viewable_variables.find_by_id(params[:column_stratum_id]) %>
      <% if @variable %>
        <div data-object="filter-html">
          <%= label :column_stratum_id, 'Stratum', class: 'control-label' %>
          <div class="controls">
            <%= @variable.display_name %><% unless @variable.variable_type == 'date' %>:
            <% option = @variable.options.select{|opt| opt[:value] == params[:column_stratum_value]}.first %>
            <% if option %>
              <%= option[:name] %>
            <% else %>
              <span class="muted">Unknown</span>
            <% end %>
            <% end %>
            <br /><strong>Include <%= params[:column_include] %></strong>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="row">
    <div class="span6 control-group">
      <% (params[:f] || []).each do |filter| %>
        <% filter[:id] = filter[:variable_id] %>
        <% v = @project.variable_by_id(filter[:id]) %>
        <% if v %>
          <div id="variable_<%= filter[:id] %>" class="filter-bubble" style="overflow:hidden;white-space:nowrap;cursor:default" data-variable-id="<%= filter[:id] %>" data-project-id="<%= v.project_id %>">
            <%= hidden_field_tag "f[][id]", filter[:id] %> <%# TODO, this one to be removed %>
            <%= hidden_field_tag "f[][variable_id]", filter[:variable_id] %>
            <%= hidden_field_tag "f[][value]", filter[:value] %>
            <%= hidden_field_tag "f[][start_date]", filter[:start_date] %>
            <%= hidden_field_tag "f[][end_date]", filter[:end_date] %>
            <% if filter[:missing] == '1' %><span class="label" style="background-color:#ffc8ba;" title="Includes Missing">m</span><% end %>
            <% if ['sheet_date', 'date'].include?(v.variable_type) %><span class="label" style="background-color:#7aa6ff;" title="by"><%= filter[:by] %></span><% end %>
            <span title="<%= v.display_name %>" style="overflow:hidden;cursor:default;font-size:0.8em">
              <%= v.display_name %>
            </span>
            <% if ['sheet_date', 'date'].include?(v.variable_type) %>
              <span class="label"><%= filter[:start_date] %></span> to <span class="label"><%= filter[:end_date] %></span>
            <% else %>
              <span class="label"><%= filter[:value] %></span>
            <% end %>
            <%#= link_to 'edit', '#', data: { object: 'edit-filter', variable_id: filter[:id], project_id: v.project_id }, class: 'btn btn-mini' %>
            <%#= link_to 'remove', "#", data: { object: 'remove-filter', target: "#variable_#{filter[:id]}" }, class: 'btn btn-mini btn-danger' %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="form-actions">
    <%= submit_tag 'Filter Search', class: 'btn btn-primary' %>

    <%= link_to 'Export', '#', class: 'btn', data: { object: 'show-contour-modal' } %>

    <%= link_to 'Reset', '#', class: 'btn', data: { target: '#sheets_search', object: 'reset-filters' } %>
  </div>
<% end %>

<div id="sheets"><div class="center"><%= image_tag "contour/ajax-loader.gif" %></div></div>
