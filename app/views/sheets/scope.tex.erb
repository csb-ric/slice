<%# scope.tex.erb %>

\documentclass{article}
\usepackage{graphicx}
\usepackage{fancyhdr}
% \usepackage[cm]{fullpage}
\usepackage[margin=0.5in]{geometry}
\geometry{top=1.0in, bottom=1.0in}
\usepackage{lastpage}
\usepackage{wrapfig}
\usepackage[section]{placeins}
\usepackage{booktabs}
\usepackage{sectsty}
\newcommand{\ra}[1]{\renewcommand{\arraystretch}{#1}}
\usepackage{indentfirst}
\usepackage{tabularx}

\usepackage{needspace}
\usepackage{color}

\fancyhf{}

\lhead{}
\chead{}
\rhead{}
\lfoot{}
\cfoot{<%= latex_safe Date.today.strftime("%B %-d, %Y") %>}
\rfoot{\thepage\ of \pageref{LastPage}}


  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
  \setlength\headheight{22pt}

\pagestyle{fancyplain}



\begin{document}

<% @sheets.each do |sheet| %>
  <% @sheet = sheet %>
  <%#= @sheet = sheet; render partial: 'sheets/print' %>

\lhead{\textbf{Subject}\\<%= latex_safe @sheet.subject.subject_code %><% if @sheet.project.acrostic_enabled? %> <%= latex_safe @sheet.subject.acrostic %><% end %>}
\chead{\textbf{Project}\\<%= latex_safe @sheet.project.name %> \textperiodcentered~<%= latex_safe @sheet.subject.site.name %>}
\rhead{\textbf{<%= latex_safe @sheet.design.study_date_name_full %>}\\<%= latex_safe @sheet.study_date.strftime("%B %-d, %Y") %>}
\lfoot{<%= latex_safe @sheet.design.name %>}
% \cfoot{<%= latex_safe Date.today.strftime("%B %-d, %Y") %>}
% \rfoot{\thepage\ of \pageref{LastPage}}



<% if @sheet.project.logo.size > 0 %>
\begin{wrapfigure}{r}
    \centering
    \includegraphics[width=25pt]{<%= @sheet.project.logo.path if @sheet.project.logo.size > 0 %>}
    \noindent
    \label{simulationfigure}
\end{wrapfigure}
<% end %>

\section*{<%= latex_safe @sheet.design.name %>}

<%= latex_safe @sheet.design.description %> \\

<% @sheet.design.options.each_with_index do |option, index| %>
  \FloatBarrier
  <% @option = option %>

  <% if @option[:variable_id].blank? %>
    \subsection*{<%= latex_safe @option[:section_name] %>}
    \hline
~
  <% elsif @variable = Variable.current.find_by_id(@option[:variable_id]) %>
    <% if @variable.variable_type == 'grid' and sheet_variable = @sheet.sheet_variables.find_by_variable_id(@variable.id) %>

\Needspace{7\baselineskip}
<% if @variable.header.blank? %>
  \subsubsection*{<%= latex_safe @variable.display_name %>}
<% else %>
  \subsubsection*{<%= latex_safe @variable.header %><% if @variable.display_name_visibility == 'visible' and @variable.variable_type != 'scale' %>\\<%= latex_safe @variable.display_name %><% end %>}
<% end %>

\begin{table*}[!htbp]\centering

\begin{tabularx}{\textwidth}{<%= 'X'*@variable.grid_variables.size %>}
<% @variable.grid_variables.each do |grid_variable| %>
  <% v = current_user.all_viewable_variables.find_by_id(grid_variable[:variable_id]) %>
  <%= latex_safe v.display_name if v %> &
<% end %>
\midrule
<% (0..sheet_variable.grids.pluck(:position).max.to_i).each do |position| %>
  <% @variable.grid_variables.each do |grid_variable| %>
    <% grid = sheet_variable.grids.find_by_variable_id_and_position(grid_variable[:variable_id], position) %>
    <% if grid %>
      <%= latex_safe grid.response_label %>
      <%= latex_safe grid.variable.units if not grid.variable.units.blank? and not grid.response_label.blank? %>
      &
    <% end %>
  <% end %>
<% end %>
\end{tabularx}
\end{table*}

    <% else %>

\Needspace{7\baselineskip}
<% if @variable.header.blank? %>
  \subsubsection*{<%= latex_safe @variable.display_name %>}
<% else %>
  \subsubsection*{<%= latex_safe @variable.header %><% if @variable.display_name_visibility == 'visible' and @variable.variable_type != 'scale' %>\\<%= latex_safe @variable.display_name %><% end %>}
<% end %>

<% if @variable.variable_type == 'checkbox' %>
  <% if @variable.response_name(@sheet).size == 0 %>
    \textcolor[gray]{0.5}{Unknown}
  <% else %>
    \begin{itemize}
      \setlength{\itemindent}{2.5em}
      <% @variable.response_name(@sheet).each do |response| %>
        \item <%= latex_safe response %>
      <% end %>
    \end{itemize}
  <% end %>
<% elsif @variable.variable_type == 'file' and @variable.response_file(@sheet).size > 0 %>
  <% if ['jpg', 'jpeg', 'gif', 'png'].include?(@variable.response_file_url(@sheet).to_s.split('.').last.downcase) %>

\begin{figure}[!htpb]
    \centering
    \includegraphics[width=6.5in]{<%= @variable.response_file(@sheet).path if @sheet.project.logo.size > 0 %>}
    <% unless @variable.description.blank? %>
      \caption{<%= latex_safe @variable.description %>}
    <% end %>
\end{figure}

  <% else %>
    <%= latex_safe @variable.response_file_url(@sheet).split('/').last %>
  <% end %>
<% elsif @variable.response_name(@sheet).blank? %>
  \textcolor[gray]{0.5}{Unknown}
<% else %>
  <%= latex_safe @variable.response_name(@sheet) %> <%= latex_safe @variable.units if not @variable.response_name(@sheet).blank? and not @variable.units.blank? %>
<% end %>

    <% end %>
  <% end %>
<% end %>

\newpage
<% end %>

\end{document}
